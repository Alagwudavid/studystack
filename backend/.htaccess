# =============================================================================
# BACKEND DIRECTORY SECURITY
# =============================================================================
# Enhanced security for Laravel backend

# Deny access to sensitive files
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

# Block access to Laravel specific files
<FilesMatch "\.(env|log|sql|sqlite|db|blade\.php|artisan)$">
    Require all denied
</FilesMatch>

# Prevent access to configuration files
<FilesMatch "(composer\.(json|lock)|package\.(json|lock)|phpunit\.xml|webpack\.mix\.js)">
    Require all denied
</FilesMatch>

# Security headers
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Frame-Options "DENY"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # CORS handling - Allow specific origins
    # For www.bitroot.com.ng requests, return www.bitroot.com.ng
    SetEnvIf Origin "^https://www\.bitroot\.com\.ng$" ACCESS_CONTROL_ALLOW_ORIGIN=https://www.bitroot.com.ng
    # For bitroot.com.ng requests, return bitroot.com.ng
    SetEnvIf Origin "^https://bitroot\.com\.ng$" ACCESS_CONTROL_ALLOW_ORIGIN=https://bitroot.com.ng
    # For localhost development
    SetEnvIf Origin "^http://localhost:3000$" ACCESS_CONTROL_ALLOW_ORIGIN=http://localhost:3000

    # Set the CORS header based on the origin
    Header always set Access-Control-Allow-Origin "%{ACCESS_CONTROL_ALLOW_ORIGIN}e" env=ACCESS_CONTROL_ALLOW_ORIGIN
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header always set Access-Control-Allow-Credentials "true"
    Header always set Vary "Origin"
</IfModule>

# Block suspicious requests
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Block SQL injection attempts
    RewriteCond %{QUERY_STRING} (union|select|insert|delete|drop|create|alter|exec|script) [NC]
    RewriteRule ^(.*)$ - [F,L]

    # Block XSS attempts
    RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} javascript: [NC,OR]
    RewriteCond %{QUERY_STRING} vbscript: [NC]
    RewriteRule ^(.*)$ - [F,L]

    # Block file inclusion attacks
    RewriteCond %{QUERY_STRING} \.\./\.\. [OR]
    RewriteCond %{QUERY_STRING} (localhost|loopback|127\.0\.0\.1) [NC,OR]
    RewriteCond %{QUERY_STRING} \.[a-z0-9] [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# Prevent access to vendor directory
<IfModule mod_alias.c>
    RedirectMatch 403 ^/vendor/.*$
</IfModule>

# Block directory browsing
Options -Indexes

# PHP security settings
<IfModule mod_php7.c>
    php_flag display_errors Off
    php_flag log_errors On
    php_flag expose_php Off
</IfModule>

<IfModule mod_php8.c>
    php_flag display_errors Off
    php_flag log_errors On
    php_flag expose_php Off
</IfModule>
